import{a as m,T as k,l as y,p as v}from"../chunks/vidstack-0a52b51e.js";import{L as d,l as w,g as E}from"../chunks/vidstack-b88fe8fa.js";import{VideoProvider as T}from"./vidstack-video.js";import{p as u,D as o,l as b,e as L,g as S,a as g,h as c,$ as I}from"../chunks/vidstack-49901be8.js";import{Q as p,c as $}from"../chunks/vidstack-4e718951.js";import{R as x}from"../chunks/vidstack-2bc28603.js";const C=n=>S(n);class D{constructor(t){this.k=null,this.m=null,this.d={},this.e=new Set,this.n=t}get instance(){return this.k}setup(t,s){this.l=s;const i=u(s.$state.streamType).includes("live"),h=u(s.$state.streamType).includes("ll-");this.k=new t({lowLatencyMode:h,backBufferLength:h?4:i?8:void 0,renderTextTracksNatively:!1,...this.d});const a=this.o.bind(this);for(const e of Object.values(t.Events))this.k.on(e,a);this.k.on(t.Events.ERROR,this.p.bind(this));for(const e of this.e)e(this.k);s.player.dispatch(new o("hls-instance",{detail:this.k})),this.k.attachMedia(this.n),this.k.on(t.Events.AUDIO_TRACK_SWITCHED,this.q.bind(this)),this.k.on(t.Events.LEVEL_SWITCHED,this.r.bind(this)),this.k.on(t.Events.LEVEL_LOADED,this.s.bind(this)),this.k.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.t.bind(this)),this.k.on(t.Events.CUES_PARSED,this.u.bind(this)),s.qualities[p.v]=this.w.bind(this),b(s.qualities,"change",this.x.bind(this)),b(s.audioTracks,"change",this.y.bind(this)),this.m=L(this.z.bind(this))}z(){if(!this.l.$state.live())return;const t=new x(this.A.bind(this));return t.D(),t.E.bind(t)}A(){this.l.$state.liveSyncPosition.set(this.k?.liveSyncPosition??1/0)}o(t,s){this.l.player?.dispatch(new o(C(t),{detail:s}))}t(t,s){const i=new o(t,{detail:s});let h=-1;for(let a=0;a<s.tracks.length;a++){const e=s.tracks[a],l=e.subtitleTrack??e.closedCaptions,r=new m({id:`hls-${e.kind}${a}`,src:l?.url,label:e.label,language:l?.lang,kind:e.kind});r[k.F]=2,r[k.G]=()=>{r.mode==="showing"?(this.k.subtitleTrack=a,h=a):h===a&&(this.k.subtitleTrack=-1,h=-1)},e.default&&r.setMode("showing",i),this.l.textTracks.add(r,i)}}u(t,s){const i=this.l.textTracks.getById(`hls-${s.track}`);if(!i)return;const h=new o(t,{detail:s});for(const a of s.cues)a.positionAlign="auto",i.addCue(a,h)}q(t,s){const i=this.l.audioTracks[s.id];i&&this.l.audioTracks[d.B](i,!0,new o(t,{detail:s}))}r(t,s){const i=this.l.qualities[s.level];i&&this.l.qualities[d.B](i,!0,new o(t,{detail:s}))}s(t,s){if(this.l.$state.canPlay())return;const{type:i,live:h,totalduration:a}=s.details,e=new o(t,{detail:s});this.l.delegate.f("stream-type-change",{detail:h?i==="EVENT"&&Number.isFinite(a)?"live:dvr":"live":"on-demand",trigger:e}),this.l.delegate.f("duration-change",{detail:a,trigger:e});const l=this.k.media;this.k.currentLevel===-1&&this.l.qualities[p.H](!0,e);for(const r of this.k.audioTracks)this.l.audioTracks[d.C]({id:r.id+"",label:r.name,language:r.lang||"",kind:"main"},e);for(const r of this.k.levels)this.l.qualities[d.C]({width:r.width,height:r.height,codec:r.codecSet,bitrate:r.bitrate},e);l.dispatchEvent(new o("canplay",{trigger:e}))}p(t,s){if(s.fatal)switch(s.type){case"networkError":this.k?.startLoad();break;case"mediaError":this.k?.recoverMediaError();break;default:this.k?.destroy(),this.k=null;break}}w(){this.k&&(this.k.currentLevel=-1)}x(){const{qualities:t}=this.l;!this.k||t.auto||(this.k[t.switch+"Level"]=t.selectedIndex,w&&(this.n.currentTime=this.n.currentTime))}y(){const{audioTracks:t}=this.l;this.k&&this.k.audioTrack!==t.selectedIndex&&(this.k.audioTrack=t.selectedIndex)}g(){this.l&&(this.l.qualities[p.v]=void 0),this.k?.destroy(),this.k=null,this.m?.(),this.m=null}}class H{constructor(t,s,i){this.I=t,this.l=s,this.N=i,this.J()}async J(){const t={onLoadStart:this.K.bind(this),onLoaded:this.L.bind(this),onLoadError:this.M.bind(this)};let s=await _(this.I,t);if(g(s)&&!c(this.I)&&(s=await R(this.I,t)),!s)return null;if(!s.isSupported()){const i="[vidstack]: `hls.js` is not supported in this environment";return this.l.player.dispatch(new o("hls-unsupported")),this.l.delegate.f("error",{detail:{message:i,code:4}}),null}return s}K(){this.l.player.dispatch(new o("hls-lib-load-start"))}L(t){this.l.player.dispatch(new o("hls-lib-loaded",{detail:t})),this.N(t)}M(t){const s=$(t);this.l.player.dispatch(new o("hls-lib-load-error",{detail:s})),this.l.delegate.f("error",{detail:{message:s.message,code:4}})}}async function R(n,t={}){if(!g(n)){if(t.onLoadStart?.(),n.prototype&&n.prototype!==Function)return t.onLoaded?.(n),n;try{const s=(await n())?.default;if(s&&s.isSupported)t.onLoaded?.(s);else throw Error("");return s}catch(s){t.onLoadError?.(s)}}}async function _(n,t={}){if(c(n)){t.onLoadStart?.();try{if(await y(n),!I(window.Hls))throw Error("");const s=window.Hls;return t.onLoaded?.(s),s}catch(s){t.onLoadError?.(s)}}}const q="https://cdn.jsdelivr.net";class f extends T{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.c=null,this.a=new D(this.video),this.b=`${q}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.c}get instance(){return this.a.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.a.d}set config(t){this.a.d=t}get library(){return this.b}set library(t){this.b=t}preconnect(){c(this.b)&&v(this.b)}setup(t){super.setup(t),new H(this.b,t,s=>{this.c=s,this.a.setup(s,t),t.delegate.f("provider-setup",{detail:this});const i=u(t.$state.source);i&&this.loadSource(i)})}async loadSource({src:t}){c(t)&&this.a.instance?.loadSource(t)}onInstance(t){const s=this.a.instance;return s&&t(s),this.a.e.add(t),()=>this.a.e.delete(t)}destroy(){this.a.g()}}f.supported=E();export{f as HLSProvider};
